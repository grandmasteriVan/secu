<!DOCTYPE html>
<html lang="uk" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#111827">
  <title>SecuLearn AI ‚Äî PWA Demo</title>
  <style>
    /* --- VARIABLES --- */
    :root {
      --bg: #f7f9fc; --card: #ffffff; --text: #0b1220; --muted: #6b7280;
      --primary: #6a5cff; --primary-hover: #5a4ce5; --primary2: #10b981;
      --stroke: #e5e7eb; --pill: #eef2ff;
      --shadow: 0 6px 24px rgba(16,24,40,.08); --radius: 16px;
      --ok: #16a34a; --warn: #f59e0b; --bad: #ef4444;
    }
    :root[data-theme="dark"] {
      --bg: #0b1220; --card: #111827; --text: #f3f6fc; --muted: #9aa4b2;
      --primary: #8f87ff; --primary-hover: #7a72e0; --primary2: #34d399;
      --stroke: #1f2b40; --pill: #1a2642;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }

    /* --- RESET & BASE --- */
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, sans-serif;
      -webkit-font-smoothing: antialiased;
    }

    /* --- LAYOUT COMPONENTS --- */
    .header {
      position: sticky; top: 0; z-index: 20; background: var(--card);
      border-bottom: 1px solid var(--stroke);
      padding: calc(10px + env(safe-area-inset-top, 0px)) 16px 10px;
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
    }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 800; font-size: 1.1rem; }
    .logo-box { width: 32px; height: 32px; border-radius: 8px; display: grid; place-items: center; background: var(--pill); border: 1px solid var(--stroke); color: var(--primary); }
    
    .container {
      padding: 20px 16px;
      padding-bottom: calc(90px + env(safe-area-inset-bottom, 0px));
      max-width: 800px; margin: 0 auto;
    }

    /* --- UI ELEMENTS --- */
    .section-title { font-size: 1.25rem; font-weight: 800; margin: 24px 0 12px; }
    .card { background: var(--card); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow); padding: 16px; margin-bottom: 16px; }
    .card h3 { margin: 0 0 8px; font-size: 1.1rem; font-weight: 700; }
    
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 500px) { .row { grid-template-columns: 1fr; } }

    .btn {
      appearance: none; border: none; background: var(--primary); color: #fff;
      border-radius: 12px; padding: 12px 16px; font-weight: 600; cursor: pointer;
      transition: opacity 0.2s; display: inline-flex; align-items: center; justify-content: center;
      font-size: 0.95rem;
    }
    .btn:active { opacity: 0.8; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn.secondary { background: transparent; border: 1px solid var(--stroke); color: var(--text); }
    .btn.block { width: 100%; }
    .btn.sm { padding: 8px 12px; font-size: 0.85rem; min-width: auto; }

    .input-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 14px; }
    .input {
      padding: 12px; border-radius: 12px; border: 1px solid var(--stroke);
      background: var(--bg); color: var(--text); width: 100%; font-size: 1rem;
      transition: border-color 0.2s;
    }
    .input:focus { outline: none; border-color: var(--primary); }

    .progress-track { height: 8px; background: var(--pill); border-radius: 99px; overflow: hidden; margin-top: 8px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--primary2)); transition: width 0.5s ease; }

    .chip { border-radius: 99px; padding: 4px 10px; background: var(--pill); border: 1px solid var(--stroke); font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 4px; }
    .chip-btn { cursor: pointer; }
    
    .text-muted { color: var(--muted); font-size: 0.9rem; }
    .text-center { text-align: center; }
    .text-right { text-align: right; }
    
    .flex-between { display: flex; justify-content: space-between; align-items: center; }
    .flex-gap { display: flex; gap: 10px; flex-wrap: wrap; }
    .flex-col { display: flex; flex-direction: column; gap: 10px; }

    /* --- TAB BAR --- */
    .tabbar {
      position: fixed; left: 0; right: 0; bottom: 0;
      background: var(--card); border-top: 1px solid var(--stroke);
      padding: 8px 8px calc(8px + env(safe-area-inset-bottom, 0px));
      display: flex; justify-content: space-around; z-index: 50;
    }
    .tab {
      flex: 1; text-align: center; font-size: 0.7rem; color: var(--muted);
      cursor: pointer; padding: 4px 0; border-radius: 8px; transition: background 0.1s;
    }
    .tab:active { background: var(--pill); }
    .tab .ico { font-size: 1.25rem; display: block; margin-bottom: 2px; }
    .tab.active { color: var(--primary); font-weight: 700; }

    /* --- UTILS --- */
    .hidden { display: none !important; }
    .screen { display: none; animation: fade-in 0.2s ease; }
    .screen.active { display: block; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: none; } }

    /* --- SPECIFIC --- */
    .chat-box { height: 60vh; overflow-y: auto; padding: 10px; display: flex; flex-direction: column; gap: 12px; }
    .chat-msg { max-width: 80%; padding: 10px 14px; border-radius: 14px; line-height: 1.4; }
    .chat-msg.user { align-self: flex-end; background: var(--primary); color: #fff; border-bottom-right-radius: 2px; }
    .chat-msg.bot { align-self: flex-start; background: var(--pill); border: 1px solid var(--stroke); border-bottom-left-radius: 2px; }

    .badge-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 12px; }
    .badge-item { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 12px; background: var(--bg); border-radius: 12px; border: 1px solid var(--stroke); }

    .status-dot { width: 10px; height: 10px; border-radius: 50%; }
    .bg-ok { background: var(--ok); } .bg-warn { background: var(--warn); } .bg-bad { background: var(--bad); }
    
    table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    th { text-align: left; padding: 8px; color: var(--muted); border-bottom: 1px solid var(--stroke); }
    td { padding: 8px; border-bottom: 1px solid var(--stroke); }
  </style>
</head>
<body>

  <header class="header">
    <div class="brand">
      <div class="logo-box">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
      </div>
      <span>SecuLearn</span>
    </div>
    <div class="flex-gap">
      <button id="theme-btn" class="chip chip-btn">üåó</button>
      <button id="lang-btn" class="chip chip-btn">UA</button>
    </div>
  </header>

  <main class="container">

    <section class="screen active" id="scr-auth">
      <h2 class="section-title" data-i18n="authTitle">–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è</h2>
      <div class="card">
        <div class="row">
          <div>
            <div class="input-group">
              <label class="text-muted" data-i18n="email">Email</label>
              <input class="input" id="auth-email" type="email" placeholder="user@company.com">
            </div>
            <div class="input-group">
              <label class="text-muted" data-i18n="password">–ü–∞—Ä–æ–ª—å</label>
              <input class="input" id="auth-pass" type="password" placeholder="********">
            </div>
            <div class="flex-gap" style="margin-top: 15px;">
              <button class="btn" onclick="fakeAuth(true)" data-i18n="signup">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
              <button class="btn secondary" onclick="fakeAuth(false)" data-i18n="signin">–£–≤—ñ–π—Ç–∏</button>
            </div>
          </div>
          <div>
            <h3 data-i18n="benefits">–ü–µ—Ä–µ–≤–∞–≥–∏</h3>
            <ul class="text-muted" style="padding-left: 20px; margin: 0;">
              <li data-i18n="b1">–ì–µ–π–º—ñ—Ñ—ñ–∫–æ–≤–∞–Ω—ñ –∫—É—Ä—Å–∏</li>
              <li data-i18n="b2">Gemini AI –∞—Å–∏—Å—Ç–µ–Ω—Ç</li>
              <li data-i18n="b3">–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ —Ç–∞ –±–µ–π–¥–∂—ñ</li>
              <li data-i18n="b4">–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞ —Ä–∏–∑–∏–∫—ñ–≤</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <section class="screen" id="scr-home">
      <h2 class="section-title" data-i18n="homeTitle">–ì–æ–ª–æ–≤–Ω–∞</h2>
      
      <div class="row">
        <div class="card">
          <div class="flex-between">
            <h3 data-i18n="progress">–ú—ñ–π –ü—Ä–æ–≥—Ä–µ—Å</h3>
            <span class="chip" id="dash-progress-text">0%</span>
          </div>
          <div class="progress-track"><div class="progress-fill" id="dash-progress-bar" style="width:0%"></div></div>
          <div class="text-muted" style="margin-top:8px; font-size:0.8rem">–î–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ —Ä—ñ–≤–Ω—è</div>
        </div>

        <div class="card">
          <h3 data-i18n="riskTitle">–†—ñ–≤–µ–Ω—å –†–∏–∑–∏–∫—É</h3>
          <div class="flex-gap" id="dash-risk-block" style="align-items: center;">
             <div class="status-dot bg-bad"></div>
             <span style="font-weight: 600;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</span>
          </div>
        </div>
      </div>

      <h2 class="section-title" data-i18n="quickActions">–î—ñ—ó</h2>
      <div class="card flex-gap">
        <button class="btn" onclick="go('sim')" data-i18n="startTraining">–¢—Ä–µ–Ω—ñ–Ω–≥</button>
        <button class="btn secondary" onclick="go('chat')" data-i18n="aiAssistant">AI –ß–∞—Ç</button>
        <button class="btn secondary" onclick="go('leader')">üèÜ –¢–æ–ø</button>
      </div>

      <h2 class="section-title">–ö—É—Ä—Å–∏</h2>
      <div id="courses-list" class="flex-col">
        <div class="text-center text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫—É—Ä—Å—ñ–≤...</div>
      </div>
    </section>

    <section class="screen" id="scr-chat">
      <h2 class="section-title">Gemini SecuBot</h2>
      <div class="card">
        <div id="chat-box" class="chat-box">
          <div class="chat-msg bot">
            üëã –ü—Ä–∏–≤—ñ—Ç! –Ø SecuBot –Ω–∞ –±–∞–∑—ñ Google Gemini. –ó–∞–ø–∏—Ç–∞–π –º–µ–Ω–µ –ø—Ä–æ —Ñ—ñ—à–∏–Ω–≥, –ø–∞—Ä–æ–ª—ñ –∞–±–æ –∫—ñ–±–µ—Ä–≥—ñ–≥—ñ—î–Ω—É.
          </div>
        </div>
        <div class="flex-gap" style="margin-top: 10px;">
          <input id="chat-input" class="input" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–∏—Ç–∞–Ω–Ω—è..." style="flex:1">
          <button class="btn" onclick="sendMsg()">‚û§</button>
        </div>
      </div>
    </section>

    <section class="screen" id="scr-sim">
      <h2 class="section-title" data-i18n="simTitle">–°–∏–º—É–ª—è—Ü—ñ—ó</h2>
      <div class="row">
        <div class="card">
          <span class="chip" style="margin-bottom:8px">Email</span>
          <h3 data-i18n="simPhish">–§—ñ—à–∏–Ω–≥ –ê—Ç–∞–∫–∞</h3>
          <p class="text-muted" data-i18n="simPhishDesc">–¢–µ—Å—Ç–æ–≤–∞ —Ä–æ–∑—Å–∏–ª–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–∏–ª—å–Ω–æ—Å—Ç—ñ.</p>
          <button class="btn sm secondary" onclick="toast('–ó–∞–ø—É—â–µ–Ω–æ —Ç–µ—Å—Ç–æ–≤—É –∞—Ç–∞–∫—É!')" data-i18n="launch">–ó–∞–ø—É—Å—Ç–∏—Ç–∏</button>
        </div>
        <div class="card">
          <span class="chip" style="margin-bottom:8px">Quiz</span>
          <h3 data-i18n="simQuiz">–ë–ª—ñ—Ü-—Ç–µ—Å—Ç</h3>
          <p class="text-muted" data-i18n="simQuizDesc">–®–≤–∏–¥–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑–Ω–∞–Ω—å –∑ AI.</p>
          <button class="btn sm secondary" onclick="go('chat')" data-i18n="startInChat">–ü–æ—á–∞—Ç–∏</button>
        </div>
      </div>
    </section>

    <section class="screen" id="scr-certs">
      <h2 class="section-title" data-i18n="certsTitle">–ú–æ—ó –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏</h2>
      <div class="card">
        <h3>Intro Security Course</h3>
        <p class="text-muted" style="margin-bottom:12px">–í–∏–¥–∞–Ω–æ: SecuLearn AI System</p>
        <button class="btn block" onclick="downloadCertificate()" data-i18n="download">–ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF</button>
      </div>
    </section>

    <section class="screen" id="scr-leader">
      <div class="flex-between" style="margin-top: 20px;">
        <h2 class="section-title" style="margin:0" data-i18n="leadTitle">–õ—ñ–¥–µ—Ä–∏</h2>
        <button class="btn sm secondary" onclick="loadLeaderboard()">‚Üª</button>
      </div>
      <div class="card" style="margin-top: 10px;">
        <div id="leaderboard-list" class="flex-col">
          <div class="text-center text-muted">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
        </div>
      </div>
    </section>

    <section class="screen" id="scr-analytics">
      <h2 class="section-title" data-i18n="analyticsTitle">–ó–≤—ñ—Ç–∏</h2>
      <div class="card">
        <h3 data-i18n="orgAvg">–°–µ—Ä–µ–¥–Ω—ñ–π —Ä—ñ–≤–µ–Ω—å –ø–æ –∫–æ–º–ø–∞–Ω—ñ—ó</h3>
        <div class="progress-track"><div class="progress-fill" style="width: 72%"></div></div>
        <p class="text-muted" style="margin-top:10px">–ù–∞ –æ—Å–Ω–æ–≤—ñ –¥–∞–Ω–∏—Ö 42 —Å–ø—ñ–≤—Ä–æ–±—ñ—Ç–Ω–∏–∫—ñ–≤.</p>
      </div>
    </section>

    <section class="screen" id="scr-admin">
      <h2 class="section-title">–ê–¥–º—ñ–Ω-–ø–∞–Ω–µ–ª—å <span id="admin-greeting" class="text-muted" style="font-size:0.6em"></span></h2>
      
      <div id="admin-access-denied" class="card hidden" style="border-left: 4px solid var(--bad);">
        –î–æ—Å—Ç—É–ø –∑–∞–±–æ—Ä–æ–Ω–µ–Ω–æ. –ü–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∞–≤–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
      </div>

      <div id="admin-panel-content" class="hidden">
        <div class="card">
          <h3>1. –î–æ–¥–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞</h3>
          <form onsubmit="event.preventDefault(); adminAddUser();">
            <div class="input-group">
              <input type="email" id="admin-email" class="input" placeholder="Email" required>
            </div>
            <div class="input-group">
              <input type="password" id="admin-password" class="input" placeholder="–ü–∞—Ä–æ–ª—å" required>
            </div>
            <div class="input-group">
              <select id="admin-role" class="input">
                <option value="user">User</option>
                <option value="manager">Manager</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <button type="submit" class="btn block">–°—Ç–≤–æ—Ä–∏—Ç–∏</button>
          </form>
        </div>

        <div class="card">
          <h3>2. –ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏ —Å–∏–º—É–ª—è—Ü—ñ—é</h3>
          <form onsubmit="event.preventDefault(); adminAssignSim();">
            <div class="row">
               <input type="number" id="assign-user-id" class="input" placeholder="ID User" required min="1">
               <select id="assign-sim-type" class="input">
                  <option value="phishing">Phishing</option>
                  <option value="quiz">Quiz</option>
               </select>
            </div>
            <button type="submit" class="btn block" style="margin-top:10px">–ü—Ä–∏–∑–Ω–∞—á–∏—Ç–∏</button>
          </form>
        </div>

        <div class="card">
  <h3>3. –°—Ç–≤–æ—Ä–∏—Ç–∏ –∫—É—Ä—Å</h3>
  <form onsubmit="event.preventDefault(); adminCreateCourse();">
    <div class="input-group">
      <label class="text-muted">–ù–∞–∑–≤–∞</label>
      <input type="text" id="c-title" class="input" required>
    </div>
    <div class="input-group">
      <label class="text-muted">–û–ø–∏—Å (–∫–æ—Ä–æ—Ç–∫–∏–π)</label>
      <input type="text" id="c-desc" class="input" required>
    </div>
    <div class="input-group">
      <label class="text-muted">–ö–æ–Ω—Ç–µ–Ω—Ç (HTML)</label>
      <textarea id="c-content" class="input" rows="4" placeholder="<p>–¢–µ–∫—Å—Ç –ª–µ–∫—Ü—ñ—ó...</p>" required></textarea>
    </div>
    <div class="row">
        <div class="input-group">
            <label class="text-muted">XP –ù–∞–≥–æ—Ä–æ–¥–∞</label>
            <input type="number" id="c-xp" class="input" value="100">
        </div>
        <div class="input-group">
            <label class="text-muted">–§–∞–π–ª –ë–µ–π–¥–∂–∞</label>
            <input type="file" id="c-badge" class="input" accept="image/*" required>
        </div>
    </div>

    <h4 style="margin: 15px 0 10px;">–ü–∏—Ç–∞–Ω–Ω—è —Ç–µ—Å—Ç—É</h4>
    <div id="questions-container" class="flex-col">
        </div>
    <button type="button" class="btn sm secondary" onclick="addQuestionField()" style="margin-bottom:15px; width:100%">+ –î–æ–¥–∞—Ç–∏ –ø–∏—Ç–∞–Ω–Ω—è</button>

    <button type="submit" class="btn block">–ó–±–µ—Ä–µ–≥—Ç–∏ –∫—É—Ä—Å</button>
  </form>
</div>

        <div class="card">
           <div class="flex-between" style="margin-bottom:10px">
              <h3>3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ</h3>
              <button class="btn sm secondary" onclick="loadUserList()">‚Üª</button>
           </div>
           <div style="overflow-x:auto;">
              <table>
                  <thead>
                      <tr><th>ID</th><th>Email</th><th>Role</th><th>XP</th></tr>
                  </thead>
                  <tbody id="user-list-body">
                      <tr><td colspan="4" class="text-center">–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –æ–Ω–æ–≤–∏—Ç–∏</td></tr>
                  </tbody>
              </table>
           </div>
        </div>
      </div>
    </section>

    <section class="screen" id="scr-course-player">
      <div class="header">
        <button class="btn sm secondary" onclick="go('home')">‚Üê –ù–∞–∑–∞–¥</button>
        <div style="font-weight:bold" id="cp-title">–ù–∞–∑–≤–∞ –∫—É—Ä—Å—É</div>
        <div style="width:40px"></div>
      </div>
      <div class="container">
        <div class="card">
            <div id="cp-content" style="line-height: 1.6; font-size: 1rem; margin-bottom: 20px;"></div>
            
            <div style="background: var(--bg); padding: 15px; border-radius: 12px;">
                <h3>‚úçÔ∏è –¢–µ—Å—Ç</h3>
                <p id="cp-question" style="font-weight: 600; margin-bottom: 10px;"></p>
                <div id="cp-options" class="flex-col"></div>
                <button id="cp-submit-btn" class="btn block" style="margin-top: 15px" onclick="submitCourse()">–ó–∞–≤–µ—Ä—à–∏—Ç–∏</button>
            </div>
        </div>
      </div>
    </section>

    <section class="screen" id="scr-profile">
      <h2 class="section-title" data-i18n="profileTitle">–ú—ñ–π –ü—Ä–æ—Ñ—ñ–ª—å</h2>
      
      <div class="row">
        <div class="card flex-col" style="align-items: center; text-align: center;">
          <div id="profile-avatar" style="width:80px; height:80px; border-radius:50%; background: linear-gradient(135deg, var(--primary), var(--primary2)); display: grid; place-items: center; font-size: 2rem; color: #fff; font-weight: bold;">U</div>
          <div>
            <div id="profile-name-display" style="font-weight: 800; font-size: 1.2rem;">User</div>
            <div id="profile-role-display" class="chip">User</div>
          </div>
          <div class="chip" style="margin-top:5px">XP: <span id="profile-xp">0</span></div>
        </div>

        <div class="card">
            <h3>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h3>
            <div class="input-group">
                <label class="text-muted">–ó–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è</label>
                <div class="flex-gap" style="flex-wrap: nowrap;">
                    <input type="text" id="edit-name-input" class="input" placeholder="–Ü–º'—è">
                    <button class="btn" onclick="updateProfile()">üíæ</button>
                </div>
            </div>
            <button class="btn block secondary" onclick="logout()" style="margin-top: 15px; color: var(--bad); border-color: var(--stroke);">–í–∏–π—Ç–∏</button>
        </div>
      </div>

      <h3 class="section-title">üèÜ –ú–æ—ó –î–æ—Å—è–≥–Ω–µ–Ω–Ω—è</h3>
      <div class="card">
          <div id="badges-container" class="badge-grid">
              <div class="text-muted" style="grid-column: 1/-1;">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
          </div>
      </div>
    </section>

  </main>

  <nav class="tabbar">
    <div class="tab" id="tab-auth" onclick="go('auth')"><span class="ico">üîê</span><span data-i18n="tabAuth">–í—Ö—ñ–¥</span></div>
    <div class="tab" id="tab-home" onclick="go('home')"><span class="ico">üè†</span><span data-i18n="tabHome">–ì–æ–ª–æ–≤–Ω–∞</span></div>
    <div class="tab" id="tab-chat" onclick="go('chat')"><span class="ico">ü§ñ</span><span data-i18n="tabChat">–ß–∞—Ç</span></div>
    <div class="tab" id="tab-sim" onclick="go('sim')"><span class="ico">üé£</span><span data-i18n="tabSim">–¢–µ—Å—Ç–∏</span></div>
    <div class="tab" id="tab-certs" onclick="go('certs')"><span class="ico">üìú</span><span data-i18n="tabCerts">–°–µ—Ä—Ç–∏—Ñ.</span></div>
    <div class="tab" id="tab-leader" onclick="go('leader')"><span class="ico">üèÖ</span><span data-i18n="tabLead">–õ—ñ–¥–µ—Ä–∏</span></div>
    <div class="tab" id="tab-profile" onclick="go('profile')"><span class="ico">üë§</span><span data-i18n="tabProfile">–ü—Ä–æ—Ñ—ñ–ª—å</span></div>
    <div class="tab hidden" id="tab-admin" onclick="go('admin')"><span class="ico">üõ†</span><span data-i18n="tabAdmin">–ê–¥–º—ñ–Ω</span></div>
  </nav>

<script>
/* ---------------- CONSTANTS & STATE ---------------- */
const API_URL = "http://77.42.35.171"; 
const L = {
  ua: { authTitle:"–í—Ö—ñ–¥ / –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è", email:"Email", password:"–ü–∞—Ä–æ–ª—å", signup:"–°—Ç–≤–æ—Ä–∏—Ç–∏", signin:"–£–≤—ñ–π—Ç–∏", homeTitle:"–ì–æ–ª–æ–≤–Ω–∞", chatTitle:"Gemini Bot", simTitle:"–°–∏–º—É–ª—è—Ü—ñ—ó", certsTitle:"–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏", adminTitle:"–ê–¥–º—ñ–Ω–∫–∞", profileTitle:"–ü—Ä–æ—Ñ—ñ–ª—å", b1:"–ì–µ–π–º—ñ—Ñ—ñ–∫–∞—Ü—ñ—è", b2:"Gemini AI", b3:"–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏", b4:"–ê–Ω–∞–ª—ñ—Ç–∏–∫–∞" },
  en: { authTitle:"Sign In / Up", email:"Email", password:"Password", signup:"Sign Up", signin:"Sign In", homeTitle:"Home", chatTitle:"Gemini Bot", simTitle:"Simulations", certsTitle:"Certificates", adminTitle:"Admin", profileTitle:"Profile", b1:"Gamification", b2:"Gemini AI", b3:"Certificates", b4:"Analytics" }
};
const $ = (id) => document.getElementById(id);
const $$ = (sel) => document.querySelectorAll(sel);
const state = { lang:'ua', theme:'dark', route:'auth' };
let qCount = 0;

/* ---------------- API HELPER ---------------- */
async function apiRequest(endpoint, method='GET', body=null, isForm=false) {
  const headers = {};
  const token = localStorage.getItem('sl_token');
  if(token) headers['Authorization'] = `Bearer ${token}`;
  
  let opts = { method, headers };
  if(body) {
    if(isForm) opts.body = body;
    else { headers['Content-Type']='application/json'; opts.body=JSON.stringify(body); }
  }

  try {
    const res = await fetch(API_URL + endpoint, opts);
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail || 'Error');
    return data;
  } catch(e) {
    if(e.message.includes('401')) logout();
    toast(`‚ö†Ô∏è ${e.message}`);
    throw e;
  }
}

/* ---------------- CORE LOGIC ---------------- */
function go(route) {
  state.route = route;
  
  // Screens
  $$('.screen').forEach(el => el.classList.remove('active'));
  const target = $('scr-'+route) || $('scr-auth');
  target.classList.add('active');

  // Tabs
  $$('.tab').forEach(el => el.classList.remove('active'));
  const tab = $('tab-'+route);
  if(tab) tab.classList.add('active');

  // Load Data
  if(route === 'home') { loadDashboard(); loadCourses(); }
  if(route === 'admin') { loadDashboard(); loadUserList(); }
  if(route === 'leader') loadLeaderboard();
  if(route === 'profile') loadProfile();
}

function toast(msg) {
  const div = document.createElement('div');
  div.className = 'card';
  div.style.cssText = "position:fixed;bottom:70px;left:50%;transform:translateX(-50%);background:var(--card);padding:10px 20px;z-index:100;border:1px solid var(--primary);box-shadow:var(--shadow)";
  div.textContent = msg;
  document.body.appendChild(div);
  setTimeout(() => div.remove(), 2000);
}

/* ---------------- FEATURES ---------------- */

// AUTH
async function fakeAuth(isSignup) {
  const email = $('auth-email').value;
  const password = $('auth-pass').value;
  if(!email || !password) return toast("–í–≤–µ–¥—ñ—Ç—å –¥–∞–Ω—ñ");

  try {
    let data;
    if(isSignup) {
      await apiRequest('/auth/register', 'POST', { email, password, full_name: email.split('@')[0] });
      toast("–ê–∫–∞—É–Ω—Ç —Å—Ç–≤–æ—Ä–µ–Ω–æ! –£–≤—ñ–π–¥—ñ—Ç—å.");
    } else {
      const fd = new FormData(); fd.append('username', email); fd.append('password', password);
      data = await apiRequest('/auth/login', 'POST', fd, true);
      localStorage.setItem('sl_token', data.access_token);
      toast("–£—Å–ø—ñ—Ö!");
      go('home');
    }
  } catch(e) {}
}

function logout() {
  localStorage.removeItem('sl_token');
  go('auth');
}

// DASHBOARD
async function loadDashboard() {
  const token = localStorage.getItem('sl_token');
  if(!token) return;
  try {
    const user = await apiRequest('/auth/me');
    
    // Admin Check
    const isAdmin = user.role === 'admin';
    const adminTab = $('tab-admin');
    if(adminTab) adminTab.classList.toggle('hidden', !isAdmin);
    
    if(state.route === 'admin') {
       $('admin-panel-content').classList.toggle('hidden', !isAdmin);
       $('admin-access-denied').classList.toggle('hidden', isAdmin);
    }

    // Stats
    const stats = await apiRequest('/dashboard/summary');
    $('dash-progress-text').textContent = `${stats.progress_percent}%`;
    $('dash-progress-bar').style.width = `${stats.progress_percent}%`;
    
    const riskEl = $('dash-risk-block');
    let colorClass = 'bg-ok';
    if(stats.risk_level.includes('–ö—Ä–∏—Ç–∏—á–Ω–∏–π')) colorClass = 'bg-bad';
    else if(stats.risk_level.includes('–°–µ—Ä–µ–¥–Ω—ñ–π')) colorClass = 'bg-warn';
    
    riskEl.innerHTML = `<div class="status-dot ${colorClass}"></div><span>${stats.risk_level}</span>`;

  } catch(e) {}
}

// COURSES
async function loadCourses() {
  const box = $('courses-list');
  try {
    const list = await apiRequest('/courses/');
    box.innerHTML = '';
    list.forEach(c => {
       const badge = c.is_completed ? '<span class="chip bg-ok" style="color:#fff">–ü—Ä–æ–π–¥–µ–Ω–æ</span>' : `<span class="chip">+${c.xp_reward} XP</span>`;
       const div = document.createElement('div');
       div.className = 'card';
       div.innerHTML = `
         <div class="flex-between"><h3>${c.title}</h3>${badge}</div>
         <p class="text-muted">${c.description}</p>
         <div class="flex-between" style="margin-top:10px">
           <span class="text-muted" style="font-size:0.8rem">üèÖ ${c.badge_name}</span>
           <button class="btn sm secondary" onclick="openCourse(${c.id})">${c.is_completed?'–©–µ —Ä–∞–∑':'–ü–æ—á–∞—Ç–∏'}</button>
         </div>
       `;
       box.appendChild(div);
    });
  } catch(e) { box.innerHTML = '–ü–æ–º–∏–ª–∫–∞'; }
}

let currCourse = null;
async function openCourse(id) {
  try {
    const data = await apiRequest(`/courses/${id}`);
    currCourse = data.id;
    $('cp-title').textContent = data.title;
    $('cp-content').innerHTML = data.content;
    
    // –†–µ–Ω–¥–µ—Ä –ø–∏—Ç–∞–Ω—å
    const quizContainer = $('cp-options'); // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —Ü–µ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –í–°–Ü–• –ø–∏—Ç–∞–Ω—å
    quizContainer.innerHTML = ''; // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—Ç–∞—Ä–µ
    $('cp-question').style.display = 'none'; // –•–æ–≤–∞—î–º–æ —Å—Ç–∞—Ä–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–¥–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–Ω—è

    data.questions.forEach((q, qIdx) => {
        const qBlock = document.createElement('div');
        qBlock.style.marginBottom = "20px";
        qBlock.style.paddingBottom = "10px";
        qBlock.style.borderBottom = "1px solid var(--stroke)";
        
        let optsHTML = '';
        q.options.forEach((optText, oIdx) => {
            optsHTML += `
                <label style="display:block; padding:8px; cursor:pointer;">
                    <input type="radio" name="q_${qIdx}" value="${oIdx}"> ${optText}
                </label>
            `;
        });

        qBlock.innerHTML = `
            <p style="font-weight:700; margin-bottom:8px">${qIdx + 1}. ${q.question}</p>
            <div>${optsHTML}</div>
        `;
        quizContainer.appendChild(qBlock);
    });
    
    $('cp-submit-btn').disabled = false;
    $('cp-submit-btn').textContent = data.is_completed ? "–ü—Ä–æ–π—Ç–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ" : "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ –∫—É—Ä—Å";
    go('course-player');
  } catch(e) { console.error(e); toast("–ü–æ–º–∏–ª–∫–∞ –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è –∫—É—Ä—Å—É"); }
}

async function submitCourse() {
    // –ó–±–∏—Ä–∞—î–º–æ –≤—Å—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ
    const quizContainer = $('cp-options');
    const questions = quizContainer.children; // div.qBlock
    const answers = [];
    
    for (let i = 0; i < questions.length; i++) {
        const selected = document.querySelector(`input[name="q_${i}"]:checked`);
        if (!selected) {
            toast(`–î–∞–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ –ø–∏—Ç–∞–Ω–Ω—è #${i+1}`);
            return;
        }
        answers.push(parseInt(selected.value));
    }

    $('cp-submit-btn').disabled = true;
    
    try {
        // –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –º–∞—Å–∏–≤ –≤—ñ–¥–ø–æ–≤—ñ–¥–µ–π: { answers: [0, 1, 3] }
        const res = await apiRequest(`/courses/${currCourse}/complete`, 'POST', { answers: answers });
        
        if(res.success) {
           toast(`üéâ –í—ñ—Ç–∞—î–º–æ! +${res.xp_gained} XP`);
           go('home');
           loadDashboard(); // –û–Ω–æ–≤–∏—Ç–∏ XP
        } else {
           toast("‚ùå " + res.message); // "–ü–æ–º–∏–ª–∫–∞ —É –ø–∏—Ç–∞–Ω–Ω—ñ ‚Ññ2..."
           $('cp-submit-btn').disabled = false;
        }
    } catch(e) { 
        $('cp-submit-btn').disabled = false; 
    }
}

// CHAT (GEMINI)
async function sendMsg() {
  const inp = $('chat-input');
  const txt = inp.value.trim();
  if(!txt) return;
  
  const box = $('chat-box');
  box.innerHTML += `<div class="chat-msg user">${txt}</div>`;
  inp.value = '';
  box.scrollTop = box.scrollHeight;

  try {
    const res = await apiRequest('/secubot/message', 'POST', { text: txt });
    box.innerHTML += `<div class="chat-msg bot">ü§ñ ${res.reply}</div>`;
  } catch(e) {
    box.innerHTML += `<div class="chat-msg bot" style="color:red">–ü–æ–º–∏–ª–∫–∞ AI</div>`;
  }
  box.scrollTop = box.scrollHeight;
}

// PROFILE
async function loadProfile() {
  try {
    const u = await apiRequest('/auth/me');
    $('profile-name-display').textContent = u.full_name || u.email.split('@')[0];
    $('profile-role-display').textContent = u.role;
    $('profile-xp').textContent = u.xp;
    $('edit-name-input').value = u.full_name || "";
    
    const initials = (u.full_name || "U").charAt(0).toUpperCase();
    $('profile-avatar').textContent = initials;

    // Badges
    const badges = await apiRequest('/courses/my/badges');
    const box = $('badges-container');
    box.innerHTML = '';

    if (badges.length === 0) {
        box.innerHTML = '<div class="text-muted">–©–µ –Ω–µ–º–∞—î –±–µ–π–¥–∂—ñ–≤</div>';
    }

    badges.forEach(b => {
      const div = document.createElement('div');
      div.className = 'badge-item';
      // –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ image_url –∑ –±–µ–∫–µ–Ω–¥—É. 
      // –Ø–∫—â–æ b.image_url –ø–æ—Ä–æ–∂–Ω—ñ–π, —Å—Ç–∞–≤–∏–º–æ –¥–µ—Ñ–æ–ª—Ç–Ω—É —ñ–∫–æ–Ω–∫—É
      const imgPath = b.image_url ? b.image_url : ''; 
      
      div.innerHTML = `
        <img src="${API_URL}${imgPath}" style="width:40px; height:40px; object-fit:contain;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/190/190411.png'">
        <div style="font-size:0.75rem; font-weight:bold; margin-top:5px;">${b.name}</div>
      `;
      box.appendChild(div);
    });

  } catch(e) {}
}

async function updateProfile() {
  const name = $('edit-name-input').value;
  if(!name) return;
  try {
    await apiRequest('/auth/profile', 'PUT', { full_name: name });
    toast("–ó–±–µ—Ä–µ–∂–µ–Ω–æ");
    loadProfile();
  } catch(e) {}
}

// LEADERBOARD
async function loadLeaderboard() {
  const box = $('leaderboard-list');
  try {
    const list = await apiRequest('/leaderboard/top');
    box.innerHTML = '';
    list.forEach((u, i) => {
       const row = document.createElement('div');
       row.className = 'flex-between card';
       row.style.marginBottom = '8px';
       row.style.padding = '10px';
       let icon = `#${i+1}`;
       if(i===0) icon='ü•á'; if(i===1) icon='ü•à'; if(i===2) icon='ü•â';
       
       row.innerHTML = `
         <div class="flex-gap" style="align-items:center">
            <span style="font-weight:bold; width:24px">${icon}</span>
            <span>${u.full_name || u.email.split('@')[0]}</span>
         </div>
         <span class="chip">${u.xp} XP</span>
       `;
       box.appendChild(row);
    });
  } catch(e) { box.innerHTML='Error'; }
}

// CERTIFICATE
async function downloadCertificate() {
  toast("–ì–µ–Ω–µ—Ä–∞—Ü—ñ—è PDF...");
  try {
    const token = localStorage.getItem('sl_token');
    const res = await fetch(API_URL + '/certificates/download/test', { headers: {'Authorization':`Bearer ${token}`} });
    if(!res.ok) throw new Error("Err");
    const blob = await res.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download="Cert.pdf"; document.body.appendChild(a); a.click(); a.remove();
  } catch(e) { toast("–ü–æ–º–∏–ª–∫–∞"); }
}

// ADMIN
async function adminAddUser() {
  const email = $('admin-email').value;
  const password = $('admin-password').value;
  const role = $('admin-role').value;
  try {
     await apiRequest('/admin/users', 'POST', {email, password, role});
     toast("–°—Ç–≤–æ—Ä–µ–Ω–æ");
     loadUserList();
  } catch(e) {}
}

async function loadUserList() {
  const tbody = $('user-list-body');
  try {
    const users = await apiRequest('/admin/users');
    tbody.innerHTML = '';
    users.forEach(u => {
      tbody.innerHTML += `<tr><td>${u.id}</td><td>${u.email}</td><td>${u.role}</td><td>${u.xp}</td></tr>`;
    });
  } catch(e) { tbody.innerHTML='<tr><td colspan="4">–ü–æ–º–∏–ª–∫–∞</td></tr>'; }
}

// INIT
$('#theme-btn').onclick = () => {
  state.theme = state.theme==='dark'?'light':'dark';
  document.documentElement.setAttribute('data-theme', state.theme);
};
if(localStorage.getItem('sl_token')) go('home');


//–∫—É—Ä—Å–∏


function addQuestionField() {
    qCount++;
    const container = document.getElementById('questions-container');
    const div = document.createElement('div');
    div.className = 'card';
    div.style.background = 'var(--bg)';
    div.style.padding = '10px';
    div.innerHTML = `
        <div class="flex-between">
            <strong>–ü–∏—Ç–∞–Ω–Ω—è #${qCount}</strong>
            <button type="button" class="btn sm secondary" style="color:var(--bad);border-color:var(--bad)" onclick="this.parentElement.parentElement.remove()">–í–∏–¥–∞–ª–∏—Ç–∏</button>
        </div>
        <input type="text" class="input q-text" placeholder="–¢–µ–∫—Å—Ç –ø–∏—Ç–∞–Ω–Ω—è" style="margin: 5px 0" required>
        
        <div class="text-muted" style="font-size:0.8em">–í–∞—Ä—ñ–∞–Ω—Ç–∏ (—á–µ—Ä–µ–∑ –∫–æ–º—É):</div>
        <input type="text" class="input q-opts" placeholder="–¢–∞–∫, –ù—ñ, –ù–µ –∑–Ω–∞—é" required>
        
        <div class="text-muted" style="font-size:0.8em">–Ü–Ω–¥–µ–∫—Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ (–ø–æ—á–∏–Ω–∞—é—á–∏ –∑ 0):</div>
        <input type="number" class="input q-correct" placeholder="0" min="0" required>
    `;
    container.appendChild(div);
}

async function adminCreateCourse() {
    const title = $('c-title').value;
    const desc = $('c-desc').value;
    const content = $('c-content').value;
    const xp = $('c-xp').value;
    const badgeFile = $('c-badge').files[0];
    
    // –ó–±–∏—Ä–∞—î–º–æ –ø–∏—Ç–∞–Ω–Ω—è
    const qElements = document.querySelectorAll('#questions-container > div');
    const questions = [];
    
    qElements.forEach(el => {
        const text = el.querySelector('.q-text').value;
        const optsRaw = el.querySelector('.q-opts').value;
        const correct = parseInt(el.querySelector('.q-correct').value);
        
        // –†–æ–∑–±–∏–≤–∞—î–º–æ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –ø–æ –∫–æ–º—ñ
        const options = optsRaw.split(',').map(s => s.trim()).filter(s => s);
        
        questions.push({
            question: text,
            options: options,
            correct: correct
        });
    });

    if(questions.length === 0) return toast("–î–æ–¥–∞–π—Ç–µ —Ö–æ—á–∞ –± –æ–¥–Ω–µ –ø–∏—Ç–∞–Ω–Ω—è!");
    if(!badgeFile) return toast("–í–∏–±–µ—Ä—ñ—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫—É!");

    // –§–æ—Ä–º—É—î–º–æ FormData
    const fd = new FormData();
    fd.append('title', title);
    fd.append('description', desc);
    fd.append('content', content);
    fd.append('xp_reward', xp);
    fd.append('questions_json', JSON.stringify(questions));
    fd.append('badge_file', badgeFile);

    try {
        const btn = event.target.querySelector('button[type="submit"]');
        btn.disabled = true; btn.textContent = "–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...";
        
        await apiRequest('/admin/courses', 'POST', fd, true); // true = isForm
        toast("–ö—É—Ä—Å —Å—Ç–≤–æ—Ä–µ–Ω–æ —É—Å–ø—ñ—à–Ω–æ!");
        
        // –û—á–∏—Å—Ç–∫–∞
        event.target.reset();
        document.getElementById('questions-container').innerHTML = '';
        qCount = 0;
        loadCourses(); // –û–Ω–æ–≤–∏—Ç–∏ —Å–ø–∏—Å–æ–∫ –Ω–∞ –≥–æ–ª–æ–≤–Ω—ñ–π
    } catch (e) {
        console.error(e);
    } finally {
        const btn = event.target.querySelector('button[type="submit"]');
        if(btn) { btn.disabled = false; btn.textContent = "–ó–±–µ—Ä–µ–≥—Ç–∏ –∫—É—Ä—Å"; }
    }
}
</script>
</body>
</html>
